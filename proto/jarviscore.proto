syntax = "proto3";

package jarviscorepb;

enum CODE {
    OK = 0;

    // addr fail 
    INVALID_ADDR = 1;
    // already in
    ALREADY_IN = 2;           
    // forward msg
    FORWARD_MSG = 3;            
    // broadcast msg
    BROADCAST_MSG = 4;          
    // no ctrl module
    NOCTRLMOD = 5;              
    // client already start
    CLIENT_ALREADY_START = 6;   
    // verify fail
    VERIFY_FAIL = 7;            
    // invalid public key
    INVALID_PUBLICKEY = 8;      
    // invalid file read size
    INVALID_FILEREADSIZE = 9;   

    // sign fail
    SIGN_FAIL = 14;
    // invalid code
    INVALID_CODE = 16;
    // leveldb iter error
    LEVELDB_ITER_ERROR = 18;

    // NodeInfoInDB decode fail
    NODEINFOINDB_DECODE_FAIL = 110;
    // NodeInfoInDB encode fail
    NODEINFOINDB_ENCODE_FAIL = 111;

    // coredb open fail
    COREDB_OPEN_FAIL = 120;
    // coredb nodeinfo put fail
    COREDB_NODEINFO_PUT_FAIL = 121;
    // coredb no addr
    COREDB_NO_ADDR = 122;

    // encode CtrlDataInDB fail
    CTRLDATAINDB_ENCODE_FAIL = 200;
    // decode CtrlDataInDB fail
    CTRLDATAINDB_DECODE_FAIL = 201;
    // save CtrlDataInDB fail
    CTRLDB_SAVE_CTRLDATA_FAIL = 202;
    // ctrldb exist strlid
    CTRLDB_EXIST_CTRLID = 203;
    // ctrldb not exist strlid
    CTRLDB_NOT_EXIST_CTRLID = 204;
}

enum NODETYPE {
    NORMAL = 0;
    SH = 1;
    TELEBOT = 2;
}

enum CHANNELTYPE {
    NODEINFO = 0;
    CTRL = 1;
}

enum CTRLTYPE {
    SHELL = 0;
    FILE = 2;
}

message PrivateKey {
    bytes priKey = 1;
}

message PublicKey {
    bytes pubKey = 1;
}

message NodeInfo {
    string servAddr = 1;
    string addr = 2;
    string name = 3;
    NODETYPE nodeType = 4;
}

message NodeInfoInDB {
    NodeInfo nodeInfo = 1;
    int32 connectNums = 2;
    int32 connectedNums = 3;
    int64 ctrlid = 4;
}

message CtrlDataInDB {
    int64 ctrlid = 1;
    CTRLTYPE ctrlType = 2;
    string forwordAddr = 3;
    bytes command = 4;
    bytes result = 5;
    int32 forwordNums = 6;
}

message Join {
    string servAddr = 1;
    string addr = 2;
    string name = 3;
    NODETYPE nodeType = 4;
}

message ReplyJoin {
    CODE code = 1;
    string addr = 2;
    string name = 3;
    NODETYPE nodeType = 4;
}

message BaseReply {
    CODE code = 1;
}

message Subscribe {
    CHANNELTYPE channelType = 1;
    string addr = 2;
}

message CtrlInfo {
    int64 ctrlid = 1;
    string destAddr = 2;
    string srcAddr = 3;
    string myAddr = 4;
    CTRLTYPE ctrlType = 5;
    bytes command = 6;
    int32 forwordNums = 7;
    bytes signR = 8;
    bytes signS = 9;
    bytes pubKey = 10;
}

message CtrlResult {
    int64 ctrlid = 1;
    string destAddr = 2;
    string srcAddr = 3;
    string myAddr = 4;
    bytes ctrlResult = 5;
    int32 forwordNums = 6;
}

message ChannelInfo {
    CHANNELTYPE channelType = 1;
    oneof data {
        NodeInfo nodeInfo = 2;
        CtrlInfo ctrlInfo = 3;
    }
}

service JarvisCoreServ {
    rpc join (Join) returns (ReplyJoin) {}
    rpc requestCtrl (CtrlInfo) returns (BaseReply) {}
    rpc replyCtrl (CtrlResult) returns (BaseReply) {}
    rpc subscribe (Subscribe) returns (stream ChannelInfo) {}
}