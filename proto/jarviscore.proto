syntax = "proto3";

package jarviscorepb;

enum NODETYPE {
    NORMAL = 0;
    SH = 1;
    TELEBOT = 2;
}

enum CHANNELTYPE {
    NODEINFO = 0;
    CTRL = 1;
}

enum CTRLTYPE {
    SHELL = 0;
    FILE = 2;
}

enum REPLYTYPE {
    NONE = 0;
    FORWARD = 1;
    BROADCAST = 2;
}

message PrivateKey {
    bytes priKey = 1;
}

message PublicKey {
    bytes pubKey = 1;
}

message NodeInfo {
    string servAddr = 1;
    string addr = 2;
    string name = 3;
    NODETYPE nodeType = 4;
}

message NodeInfoInDB {
    NodeInfo nodeInfo = 1;
    int32 connectNums = 2;
    int32 connectedNums = 3;
    int64 ctrlid = 4;
}

message CtrlDataInDB {
    int64 ctrlid = 1;
    CTRLTYPE ctrlType = 2;
    string forwordAddr = 3;
    bytes command = 4;
    bytes result = 5;
    int32 forwordNums = 6;
}

message Join {
    string servAddr = 1;
    string addr = 2;
    string name = 3;
    NODETYPE nodeType = 4;
}

message ReplyJoin {
    string err = 1;
    string addr = 2;
    string name = 3;
    NODETYPE nodeType = 4;
}

message BaseReply {
    string err = 1;
    REPLYTYPE replyType = 2;
}

message Subscribe {
    CHANNELTYPE channelType = 1;
    string addr = 2;
}

message CtrlInfo {
    int64 ctrlid = 1;
    string destAddr = 2;
    string srcAddr = 3;
    string myAddr = 4;
    CTRLTYPE ctrlType = 5;
    bytes command = 6;
    int32 forwordNums = 7;
    bytes signR = 8;
    bytes signS = 9;
    bytes pubKey = 10;
}

message CtrlResult {
    int64 ctrlid = 1;
    string destAddr = 2;
    string srcAddr = 3;
    string myAddr = 4;
    bytes ctrlResult = 5;
    int32 forwordNums = 6;
}

message ChannelInfo {
    CHANNELTYPE channelType = 1;
    oneof data {
        NodeInfo nodeInfo = 2;
        CtrlInfo ctrlInfo = 3;
    }
}

service JarvisCoreServ {
    rpc join (Join) returns (ReplyJoin) {}
    rpc requestCtrl (CtrlInfo) returns (BaseReply) {}
    rpc replyCtrl (CtrlResult) returns (BaseReply) {}
    rpc subscribe (Subscribe) returns (stream ChannelInfo) {}
}